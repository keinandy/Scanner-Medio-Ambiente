<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Scanner Ambiental - Diagn√≥stico Empresarial</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0066DC; --primary-orange: #E74100;
            --env-green: #B2BF30; --dark-bg: #2D2D2D; --card-bg: #333333;
            --text-light: #FFFFFF; --text-gray: #999999; --border-gray: #444444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #b3be3d; color: var(--text-light); min-height: 100vh; transition: background 0.5s ease; }
        body.dark-mode { background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%); }
        
        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary-blue), #004AAE); padding: 1.5rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border-bottom: 2px solid var(--primary-orange); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700; }
        .logo img { height: 40px; border-radius: 6px; }
        .header-progress { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; color: rgba(255,255,255,0.8); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .screen { display: none; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PANTALLA DE CARGA INICIAL */
        .loading-screen { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 60vh; 
            text-align: center;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #1a1a1a; font-size: 1.1rem; font-weight: 600; }
        .loading-subtext { color: #333; font-size: 0.9rem; margin-top: 0.5rem; }

        /* BOTONES */
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue), #004AAE); color: white; border: none; padding: 1rem 2rem; font-weight: 600; border-radius: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-size: 1rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,102,220,0.4); }
        .btn-secondary { background: transparent; color: white; border: 2px solid var(--border-gray); padding: 0.8rem 1.5rem; font-weight: 500; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .btn-secondary:hover { border-color: var(--primary-blue); background: rgba(0,102,220,0.1); }
        .btn-back { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border-gray); padding: 0.6rem 1.2rem; font-weight: 500; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-size: 0.9rem; }
        .btn-back:hover { background: rgba(255,255,255,0.15); border-color: var(--text-gray); }

        /* CARDS EMPRESA */
        .empresa-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .empresa-card { background: white; border: 2px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 2rem; cursor: pointer; text-align: center; transition: all 0.3s; color: #333; }
        .empresa-card:hover { border-color: var(--primary-blue); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .empresa-card h3 { color: #1a1a1a; }
        .empresa-icon { font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem; }
        
        /* PREGUNTAS */
        .question-container { max-width: 800px; margin: 2rem auto; background: var(--card-bg); padding: 3rem; border-radius: 16px; border: 1px solid var(--border-gray); }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .question-text { font-size: 1.4rem; font-weight: 600; margin-bottom: 2rem; line-height: 1.5; }
        .answer-buttons { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem; }
        .btn-answer { flex: 1; max-width: 200px; padding: 1.5rem; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; background: #1A1A1A; color: white; border: 2px solid var(--border-gray); transition: all 0.3s; }
        .btn-answer.si:hover { border-color: var(--env-green); background: rgba(178, 191, 48, 0.15); }
        .btn-answer.no:hover { border-color: var(--primary-orange); background: rgba(231, 65, 0, 0.15); }
        .navigation-buttons { display: flex; justify-content: center; padding-top: 1rem; border-top: 1px solid var(--border-gray); }

        /* RESULTADOS */
        .results-header { text-align: center; margin-bottom: 2rem; }
        .nivel-badge { font-size: 1.5rem; padding: 1rem 2rem; border-radius: 12px; display: inline-block; margin: 1rem 0; font-weight: 700; }
        .nivel-excelente { background: var(--env-green); color: #1a1a1a; }
        .nivel-bueno { background: var(--primary-blue); }
        .nivel-regular { background: var(--primary-orange); }
        .nivel-inicial { background: #666; }
        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 3rem; flex-wrap: wrap; }
        
        /* FORMULARIO */
        .form-input { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid var(--border-gray); background: #1a1a1a; color: white; font-size: 1rem; transition: border-color 0.2s; }
        .form-input:focus { border-color: var(--primary-blue); outline: none; }
        .form-label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.9rem; font-weight: 500; }
        
        /* INFO BOXES */
        .info-boxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 2rem auto 3rem; max-width: 900px; }
        .info-box { background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(0,0,0,0.1); }
        .info-box-title { color: var(--primary-blue); font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .info-box-desc { color: #555; font-size: 0.9rem; }

        /* PROGRESS BAR */
        .progress-container { max-width: 800px; margin: 0 auto 1rem; }
        .progress-bar { height: 6px; background: var(--border-gray); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--env-green)); transition: width 0.3s ease; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="https://i.imgur.com/1PrgQLh.jpg" alt="Compromiso Pro">
                <span>COMPROMISO PRO</span>
            </div>
            <div class="header-progress">
                <span id="progressText"></span>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- PANTALLA 0: CARGA INICIAL -->
        <div id="loadingInitialScreen" class="screen active">
            <div class="loading-screen">
                <img src="https://i.imgur.com/1PrgQLh.jpg" alt="Compromiso Pro" style="height: 80px; border-radius: 12px; margin-bottom: 2rem;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Cargando cuestionarios...</div>
                <div class="loading-subtext">Preparando tu diagn√≥stico ambiental</div>
            </div>
        </div>

        <!-- PANTALLA 1: BIENVENIDA -->
        <div id="welcomeScreen" class="screen">
            <div style="text-align: center; padding: 3rem 0;">
                <img src="https://i.imgur.com/1PrgQLh.jpg" alt="Compromiso Pro" style="height: 80px; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: #1a1a1a;">SCANNER AMBIENTAL</h1>
                <p style="color: #333; font-size: 1.2rem; max-width: 600px; margin: 0 auto;">
                    Identifica en cu√°l de las 5 √°reas ambientales debes enfocarte primero.
                </p>
                
                <div class="info-boxes">
                    <div class="info-box">
                        <div class="info-box-title"><i class="fas fa-clipboard-check"></i> ¬øQu√© evaluaremos?</div>
                        <div class="info-box-desc">Gesti√≥n de residuos, Eficiencia h√≠drica, Certificaciones, Huella de carbono, Energ√≠a.</div>
                    </div>
                    <div class="info-box">
                        <div class="info-box-title"><i class="fas fa-clock"></i> Tiempo estimado</div>
                        <div class="info-box-desc">5 minutos. Recibir√°s un reporte PDF con tu diagn√≥stico personalizado.</div>
                    </div>
                </div>
            </div>
            
            <h2 style="text-align: center; margin-top: 1rem; color: #1a1a1a;">Selecciona tu tipo de empresa:</h2>
            <div class="empresa-grid" id="empresaGrid"></div>

            <!-- Formulario Datos Usuario -->
            <div id="userDataForm" style="display: none; max-width: 450px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 1.5rem; text-align: center; color: var(--primary-blue);">Completa tus datos para iniciar</h3>
                
                <label class="form-label" style="color: #333;">Nombre Completo *</label>
                <input type="text" id="userName" class="form-input" placeholder="Ej: Juan P√©rez" style="background: #f5f5f5; color: #333; border-color: #ddd;">
                
                <label class="form-label" style="color: #333;">Nombre de la Empresa *</label>
                <input type="text" id="companyName" class="form-input" placeholder="Ej: Constructora ABC Ltda." style="background: #f5f5f5; color: #333; border-color: #ddd;">
                
                <label class="form-label" style="color: #333;">RUT Empresa *</label>
                <input type="text" id="userRut" class="form-input" placeholder="Ej: 76.123.456-7" style="background: #f5f5f5; color: #333; border-color: #ddd;">
                
                <label class="form-label" style="color: #333;">Correo Electr√≥nico *</label>
                <input type="email" id="userEmail" class="form-input" placeholder="Ej: contacto@empresa.cl" style="background: #f5f5f5; color: #333; border-color: #ddd;">
                
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 1.5rem;">
                    * Campos obligatorios. El reporte ser√° enviado a este correo.
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button class="btn-secondary" onclick="volverSeleccionEmpresa()" style="flex: 1; color: #333; border-color: #999;">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                    <button class="btn-primary" onclick="startSurvey()" style="flex: 2;">
                        <i class="fas fa-play"></i> Comenzar
                    </button>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: PREGUNTAS -->
        <div id="questionScreen" class="screen">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="question-container">
                <div class="question-header">
                    <span id="rutaBadge" style="color: var(--primary-blue); font-weight: 700; text-transform: uppercase; font-size: 0.9rem;">CATEGOR√çA</span>
                    <span id="questionCounter" style="color: var(--text-gray); font-size: 0.9rem;">1 / 20</span>
                </div>
                <div class="question-text" id="questionText">...</div>
                <div class="answer-buttons">
                    <button class="btn-answer si" onclick="answerQuestion(true)"><i class="fas fa-check"></i> S√ç</button>
                    <button class="btn-answer no" onclick="answerQuestion(false)"><i class="fas fa-times"></i> NO</button>
                </div>
                <div class="navigation-buttons">
                    <button class="btn-back" id="btnRetroceder" onclick="retrocederPregunta()">
                        <i class="fas fa-arrow-left"></i> Pregunta anterior
                    </button>
                </div>
            </div>
        </div>

        <!-- PANTALLA 3: RESULTADOS -->
        <div id="resultsScreen" class="screen">
            <div class="results-header">
                <h1>Resultados del Diagn√≥stico</h1>
                <div id="nivelBadge" class="nivel-badge">Calculando...</div>
                <div style="font-size: 3rem; font-weight: 700; margin: 1rem 0;" id="scoreDisplay">0%</div>
                <div id="orientationMessage" style="max-width: 700px; margin: 0 auto; color: var(--text-gray); line-height: 1.6;"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="restartScanner()">
                    <i class="fas fa-redo"></i> Nueva Evaluaci√≥n
                </button>
                <button class="btn-primary" onclick="generarPDFPro()" style="background: linear-gradient(135deg, #28a745, #218838);">
                    <i class="fas fa-file-pdf"></i> Descargar Reporte PRO
                </button>
            </div>
            <p style="text-align: center; color: #888; margin-top: 1rem; font-size: 0.9rem;">
                <i class="fas fa-envelope"></i> Tambi√©n recibir√°s una copia en tu correo.
            </p>
        </div>

        <!-- PANTALLA LOADING GEN√âRICO -->
        <div id="loadingScreen" class="screen" style="text-align: center; padding-top: 5rem;">
            <div class="loading-spinner" style="margin: 0 auto 1.5rem;"></div>
            <p style="color: var(--text-gray);">Procesando datos...</p>
        </div>

    </div>

    <script>
        // ‚ö†Ô∏è URL DE TU SCRIPT
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSTk-HOa7xncw4KhtqkN7th6EroL2zQtjVilj0sYLZqNIGH22ZdgR3SPHUSPgTrp2O/exec';
        
        let appData = {};
        let currentState = { 
            respuestas: [], 
            preguntasFiltradas: [], 
            preguntaActual: 0,
            historialRespuestas: [] // Para el bot√≥n retroceder
        };

        window.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                const res = await fetch(APPS_SCRIPT_URL);
                const data = await res.json();
                appData = data;
                renderEmpresas();
                // Mostrar pantalla de bienvenida
                showScreen('welcomeScreen');
                console.log("Datos cargados correctamente.");
            } catch (e) {
                console.error(e);
                document.querySelector('.loading-text').textContent = 'Error al cargar';
                document.querySelector('.loading-subtext').textContent = 'Revisa tu conexi√≥n e intenta de nuevo';
            }
        }

        function renderEmpresas() {
            const grid = document.getElementById('empresaGrid');
            grid.innerHTML = '';
            if (!appData.empresas) return;
            
            appData.empresas.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'empresa-card';
                let icon = emp.icono || 'fa-building';
                if (!icon.includes('fa-')) icon = 'fa-' + icon;
                
                div.innerHTML = `<div class="empresa-icon"><i class="fas ${icon}"></i></div><h3>${emp.tipo}</h3><p style="color: var(--text-gray); font-size: 0.9rem; margin-top: 0.5rem;">${emp.desc||''}</p>`;
                div.onclick = () => seleccionarEmpresa(emp.tipo);
                grid.appendChild(div);
            });
        }

        function seleccionarEmpresa(tipo) {
            currentState.empresaSeleccionada = tipo;
            document.getElementById('empresaGrid').style.display = 'none';
            document.querySelector('#welcomeScreen h2').style.display = 'none';
            document.querySelector('#welcomeScreen > div').style.display = 'none';
            document.getElementById('userDataForm').style.display = 'block';
        }

        function volverSeleccionEmpresa() {
            document.getElementById('empresaGrid').style.display = 'grid';
            document.querySelector('#welcomeScreen h2').style.display = 'block';
            document.querySelector('#welcomeScreen > div').style.display = 'block';
            document.getElementById('userDataForm').style.display = 'none';
            currentState.empresaSeleccionada = null;
        }

        function startSurvey() {
            const nombre = document.getElementById('userName').value.trim();
            const empresa = document.getElementById('companyName').value.trim();
            const rut = document.getElementById('userRut').value.trim();
            const email = document.getElementById('userEmail').value.trim();

            if (!nombre || !empresa || !rut || !email) {
                alert("‚ö†Ô∏è Por favor, completa todos los campos obligatorios.");
                return;
            }
            if (!email.includes('@')) {
                alert("‚ö†Ô∏è Por favor ingresa un correo electr√≥nico v√°lido.");
                return;
            }

            currentState.userName = nombre;
            currentState.companyName = empresa;
            currentState.userRut = rut;
            currentState.userEmail = email;
            
            currentState.preguntasFiltradas = appData.preguntas.filter(p => {
                if (!p.tipo_empresa) return false; 
                const tipos = p.tipo_empresa.split(',').map(t => t.trim());
                return tipos.includes(currentState.empresaSeleccionada) || tipos.includes('Todas');
            }).sort((a,b) => a.orden - b.orden);

            if (currentState.preguntasFiltradas.length === 0) {
                alert(`‚ö†Ô∏è No se encontraron preguntas para "${currentState.empresaSeleccionada}".`);
                return;
            }

            currentState.preguntaActual = 0;
            currentState.respuestas = [];
            currentState.historialRespuestas = [];
            currentState.saltadas = new Set();
            
            showScreen('questionScreen');
            renderQuestion();
        }

        function renderQuestion() {
            const p = currentState.preguntasFiltradas[currentState.preguntaActual];
            
            // Saltar preguntas marcadas
            if (currentState.saltadas.has(p.id)) {
                currentState.preguntaActual++;
                if (currentState.preguntaActual >= currentState.preguntasFiltradas.length) return finishSurvey();
                return renderQuestion();
            }

            document.getElementById('rutaBadge').innerText = p.categoria;
            document.getElementById('questionText').innerText = p.pregunta;
            
            // Contador y progreso
            const current = currentState.preguntaActual + 1;
            const total = currentState.preguntasFiltradas.length;
            document.getElementById('questionCounter').innerText = `${current} / ${total}`;
            document.getElementById('progressText').innerText = `Pregunta ${current} de ${total}`;
            document.getElementById('progressBar').style.width = `${(current / total) * 100}%`;

            // Bot√≥n retroceder
            const btnRetroceder = document.getElementById('btnRetroceder');
            if (currentState.preguntaActual === 0) {
                btnRetroceder.innerHTML = '<i class="fas fa-arrow-left"></i> Cambiar cuestionario';
            } else {
                btnRetroceder.innerHTML = '<i class="fas fa-arrow-left"></i> Pregunta anterior';
            }
        }

        function answerQuestion(val) {
            const p = currentState.preguntasFiltradas[currentState.preguntaActual];
            
            // Guardar en historial para poder retroceder
            currentState.historialRespuestas.push({
                index: currentState.preguntaActual,
                respuesta: {
                    id: p.id, categoria: p.categoria, pregunta: p.pregunta,
                    recomendacion: p.recomendacion_si_no, peso: p.peso, respuesta: val
                },
                saltadasAntes: new Set(currentState.saltadas)
            });

            currentState.respuestas.push({
                id: p.id, categoria: p.categoria, pregunta: p.pregunta,
                recomendacion: p.recomendacion_si_no, peso: p.peso, respuesta: val
            });

            // Si responde NO, saltar preguntas hijas
            if (!val && p.id) {
                const hijas = currentState.preguntasFiltradas.filter(h => h.madre === p.id);
                hijas.forEach(h => {
                    currentState.saltadas.add(h.id);
                    currentState.respuestas.push({id: h.id, categoria: h.categoria, respuesta: false, peso: h.peso, skipped: true});
                });
            }

            currentState.preguntaActual++;
            if (currentState.preguntaActual >= currentState.preguntasFiltradas.length) finishSurvey();
            else renderQuestion();
        }

        function retrocederPregunta() {
            if (currentState.preguntaActual === 0) {
                // Volver a selecci√≥n de cuestionario
                if (confirm('¬øDeseas cambiar el tipo de cuestionario?')) {
                    showScreen('welcomeScreen');
                    volverSeleccionEmpresa();
                }
                return;
            }

            // Restaurar estado anterior
            const ultimo = currentState.historialRespuestas.pop();
            if (ultimo) {
                // Quitar la √∫ltima respuesta
                currentState.respuestas = currentState.respuestas.filter(r => r.id !== ultimo.respuesta.id && !r.skipped);
                
                // Tambi√©n quitar respuestas skipped que se agregaron
                const hijasDelUltimo = currentState.preguntasFiltradas.filter(h => h.madre === ultimo.respuesta.id);
                hijasDelUltimo.forEach(h => {
                    currentState.respuestas = currentState.respuestas.filter(r => r.id !== h.id);
                });

                // Restaurar saltadas
                currentState.saltadas = ultimo.saltadasAntes;
                currentState.preguntaActual = ultimo.index;
                renderQuestion();
            }
        }

        function finishSurvey() {
            showScreen('loadingScreen');
            
            let total = 0, obtained = 0;
            currentState.respuestas.forEach(r => {
                if (!r.skipped) total += (r.peso || 0);
                if (r.respuesta) obtained += (r.peso || 0);
            });
            
            const score = total === 0 ? 0 : Math.round((obtained/total)*100);
            let nivel = "INICIAL", clase = "nivel-inicial", msg = "Est√°s comenzando tu camino hacia la sostenibilidad.";
            if(score >= 40) { nivel = "REGULAR"; clase = "nivel-regular"; msg = "Tienes avances importantes, pero falta estructura."; }
            if(score >= 60) { nivel = "BUENO"; clase = "nivel-bueno"; msg = "Buen camino, enf√≥cate en certificar tus logros."; }
            if(score >= 80) { nivel = "EXCELENTE"; clase = "nivel-excelente"; msg = "Eres l√≠der en sostenibilidad. ¬°Felicitaciones!"; }

            currentState.resultados = { score, nivel, msg };
            document.getElementById('nivelBadge').innerText = nivel;
            document.getElementById('nivelBadge').className = `nivel-badge ${clase}`;
            document.getElementById('scoreDisplay').innerText = score + '%';
            document.getElementById('orientationMessage').innerText = msg;
            
            saveData(score, nivel);
            setTimeout(() => showScreen('resultsScreen'), 1000);
        }

        function saveData(score, nivel) {
            const payload = {
                action: 'save',
                tipo_empresa: currentState.empresaSeleccionada,
                email_usuario: currentState.userEmail,
                nombre_usuario: currentState.userName,
                porcentaje_general: score,
                nivel: nivel,
                respuestas: currentState.respuestas
            };
            fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }

        function generarPDFPro() {
            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            btn.disabled = true;

            const falladas = currentState.respuestas.filter(r => r.respuesta === false && !r.skipped);
            const recomendaciones = falladas.map(f => {
                const tools = appData.herramientas.filter(h => 
                    h.id_vinculados && h.id_vinculados.includes(f.id)
                ).map(h => ({
                    nombre: h.nombre, uso: h.desc_uso || "", url: h.url || "",
                    tipo: h.tipo, duracion: h.duracion, costo: h.costo, nivel: h.nivel
                }));
                return {
                    categoria: f.categoria, pregunta: f.pregunta,
                    consejo: f.recomendacion || "Revisar documentaci√≥n.", herramientas: tools
                };
            });

            const payload = {
                action: 'generar_pdf',
                meta: {
                    fecha: new Date().toLocaleDateString('es-CL'),
                    empresa: currentState.companyName, // Nombre real de la empresa
                    tipo_empresa: currentState.empresaSeleccionada, // Tipo de cuestionario
                    usuario: currentState.userName,
                    email_usuario: currentState.userEmail,
                    rut_empresa: currentState.userRut,
                    nivel: currentState.resultados.nivel,
                    puntaje: currentState.resultados.score.toString(),
                    mensaje_orientacion: currentState.resultados.msg
                },
                lista_recomendaciones: recomendaciones
            };

            fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'success') {
                        downloadBase64(d.base64, d.nombreArchivo);
                        alert("‚úÖ ¬°Reporte generado! Tambi√©n lo recibir√°s en tu correo.");
                    } else {
                        alert("Error: " + d.message);
                    }
                    btn.innerHTML = original; 
                    btn.disabled = false;
                })
                .catch(e => {
                    alert("Error de conexi√≥n.");
                    btn.innerHTML = original; 
                    btn.disabled = false;
                });
        }

        function downloadBase64(b64, name) {
            const a = document.createElement('a');
            a.href = `data:application/pdf;base64,${b64}`;
            a.download = name;
            a.click();
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Cambiar a modo oscuro en preguntas y resultados
            if (id === 'questionScreen' || id === 'resultsScreen' || id === 'loadingScreen') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Limpiar header progress si no es pantalla de preguntas
            if (id !== 'questionScreen') {
                document.getElementById('progressText').innerText = '';
            }
        }

        function restartScanner() { 
            location.reload(); 
        }
    </script>
</body>
</html>
